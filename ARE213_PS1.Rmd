---
title: "ARE 213 Problem Set 1"
output:
  pdf_document: default
  html_notebook: default
---

```{r}
rm(list = ls())
library(pacman)
p_load("foreign","dplyr","magrittr","knitr","myFuncs","ggplot2")
theme_plot <- theme(
  legend.position = "right",
  panel.background = element_rect(fill = NA),
  panel.border = element_rect(fill = NA, color = "grey75"),
  axis.ticks = element_line(color = "grey85"),
  panel.grid.major = element_line(color = "grey95", size = 0.2),
  panel.grid.minor = element_line(color = "grey95", size = 0.2),
  legend.key = element_blank(),
  legend.title = element_blank(),
  legend.spacing.x = unit(0.3, "cm"))

#setwd("~/Dropbox/Berkeley_tings/Fall 2018/ARE213/Problem Sets/PS1")
setwd("C:\\Users\\will-\\Desktop\\are213")
dat <- read.dta("ps1.dta")
```

# 1a - Fix Missing Values (Last 15 columns)
```{r 1a}
# Missing Data Codes (herpes = 8 (not stated in codebook), tobacco = 9, cigar = 99, cigar6 = 6, alcohol = 9, drink = 99, drink5 = 5, wgain = 99)
dat %<>% filter(herpes != 8 & tobacco != 9 & cigar != 99 & cigar6 != 6 & alcohol != 9 & drink != 99 & drink5 != 5 & wgain != 99)
```

# 1b - Missing Data Discussion
The data being dropped were only from variables related to sexually transmitted disease (herpes), smoking and alcohol consumption, and weight gain.  Each of these variables are more sensitive and potentially incriminating information for patient participants, and therefore may be underreported or undisclosed much more than other characteristics, such as having hypertension or anemia.  The omission of such data therefore may not be random, but could be correlated with other variables that correlate with the incidence of these conditions and behaviors.  Therefore, we might end up with lots of omitted individuals with high-risk lifestyles, which could produced biased results. One way to see if these data omissions truly are random would be to create dummy variables for each variable that has missing data (i.e. 0 - not missing, 1 - missing) and use this as an outcome variable in a logistic regression, to see if the beta coefficients of all other variables are statistically significant and non-zero. If so, we might conclude that the probability of a missing data value being present for a given high-risk lifestyle variable i not random, but in fact related to other non-missing variables.

#1c - Summary Stats
```{r 1c}
sumstat <- as.data.frame(cbind(apply(dat,2,mean),apply(dat,2,sd), apply(dat,2,min), apply(dat,2,max))) %>%
  set_colnames(c("Mean","SD","Min","Max")) %>% round(3)

Variables <- c("Record Type","Place of Birth Recode","Attendant at Birth","Population of County of Occurence","State of Residence (FIPS)","Age of Mother","Hispanic Origin of Mother","Race of Mother Recode","Education of Mother Detail","Marital Status of Mother","Adequacy of Care Recode","Number of Live Births, Now Living","Detail Live Birth Order","Detail Total Birth Order","Total Birth Order Recode","Detail Month of Pregnancy Prenatal Care Began","Total Number of Prenatal Visits","Interval Since Last Live Birth","Interval Since Last Live Birth Recode","Age of Father","Hispanic Origin of Father","Education of Father Detail","Month of Birth","Day of Week of Birth","Gestation - Detail in Weeks","Sex","Birth Weight - Detail in Grams","Plurality","One Minute APGAR Score","Five Minute APGAR Score","Clinical Estimate of Gestation","Method of Delivery Recode","Anemia","Cardiac Disease","Acute or Chronic Lung Disease","Diabetes","Genital Herpes","Chronic Hypertension","Pregnancy-Associated Hypertension","Previous Infant 4000+ Grams","Previous Preterm or Small-for-Gestational-Age Infant","Tobacco Use During Pregnancy","Average Number of Cigarettes per Day","Average Number of Cigarettes per Day Recode","Alcohol Use During Pregnancy","Average Number of Drinks per Week","Average Number of Drinks per Week Recode","Weight Gain in Pounds")
sumstat <- as.data.frame(cbind(Variables,sumstat))
kable(sumstat)
```

#2a - Mean difference in APGAR scores
```{r}
omaps <- cbind(c(mean(dat$omaps[dat$tobacco == 1]),mean(dat$omaps[dat$tobacco == 2])))
fmaps <- cbind(c(mean(dat$fmaps[dat$tobacco == 1]),mean(dat$fmaps[dat$tobacco == 2])))
bweight <- cbind(c(mean(dat$dbrwt[dat$tobacco == 1]),mean(dat$dbrwt[dat$tobacco == 2])))

psmoking.dat <- as.data.frame(cbind(omaps,fmaps,bweight)) %>% set_colnames(c("One-Minute APGAR Score", "Five-Minute APGAR Score", "Birthweight")) %>% set_rownames(c("Smoking While Pregnant", "No Smoking While Pregnant"))
```

#2b
One could identify the ATE of maternal smoking by comparing the unadjusted difference in mean birth weight of infants of smoking and non-smoking mothers only if they were reasonably certain that all observable determinants of infant birth weight were measured for the sample, and any onobservable determinants of birth weight were accounted for via instrumental variables of some kind.  Furthermore, the treatment, in this case smoking while pregnant, would have to be randomely distributed across all of these determinants, such that the likelihood of the treatment status of each individual was independent of the other determinants of infant birthweight.  In other words, the treatment assignment is "as good as randomely assigned" after you condition on the observable factors, or other potential birthweight determinants.

If these assumptions were to hold, and we can claim that the difference in average birthweights of infants between mothers who were smokers during pregnancy and those that weren't is in fact the average treatment effect (ATE) of smoking while pregnant, then we would calculte this ATE to be roughly -240 grams.  In other words, we would claim that smoking while pregnant will, on average, reduce your child's weight at birth by 240 grams.
```{r}
ggdat <- dat %>% mutate(tobaccofact = dat$tobacco)
ggdat$tobaccofact[ggdat$tobaccofact == 1] <- "Smoker"
ggdat$tobaccofact[ggdat$tobaccofact == 2] <- "NonSmoker"
ggplot(ggdat, aes(dbrwt, colour = tobaccofact, fill = tobaccofact)) + geom_density(alpha = 0.1) + theme_plot + xlab("Birthweight (grams)") + geom_vline(xintercept = psmoking.dat$Birthweight[1], linetype = 'dashed', color = "#ba0000") + geom_vline(xintercept = psmoking.dat$Birthweight[2], linetype = 'dashed', color = "#138400") + scale_color_manual(values = c("#138400","#ba0000")) + scale_fill_manual(values = c("#4cd136","#ff7575")) + ggtitle("Distribution of Infant Birthweights by Maternal Smoking Habits")

```

```{r}
psmoke.all <- dat %>% group_by(tobacco) %>% summarise_all(mean) %>% round(3) %>% t() 
psmoke.all <- psmoke.all[-1,]
psmoke.all <- cbind(round(colMeans(dat[,-which(names(dat)=="tobacco")]),3),psmoke.all) %>% set_colnames(c("Average", "Smoker", "Non Smoker")) %>% as.data.frame()
                    

```

